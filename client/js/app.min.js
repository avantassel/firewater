var firewaterApp=angular.module("firewater",["lbServices","ui.router","leaflet-directive","duScroll","nvd3","ui.bootstrap","ngGeolocation"]).config(function(e,t,s,r,o,i){o.defaults.useXDomain=!0,o.defaults.headers.common="Content-Type: application/xml",delete o.defaults.headers.common["X-Requested-With"],i.strictMode(!1),e.state("home",{url:"",controller:"mainCtrl",templateUrl:"views/home.html"}).state("state",{url:"/state/:state",controller:"mainCtrl",templateUrl:"views/home.html"}).state("location",{url:"/location/:lat,:lng",controller:"mainCtrl",templateUrl:"views/home.html"}).state("otherwise",{url:"*path",templateUrl:"views/not-found.html"}),r.debugEnabled(!1)});firewaterApp.controller("mainCtrl",function(e,t,s,o,i,a,n,c,l){t.geocode={state:s.state||"US",formatted_address:"Locating...",elev:0,geometry:{location:{lat:s.lat||0,lng:s.lng||0}}},t.currentName=o.current.name,t.position=null,t.forecast=null,t.alerts=null,t.searching="Analyzing weather events past and present...",t.areaPolygonAlerts=null,t.geoAlerts={},t.markers=[],t.geojson={floods:{},fires:{},winter:{},other:{}},t.nearest={alert:{miles:0,elev:0,type:"",icon:"circle-o-notch fa-spin",lat:0,lng:0,message:"Searching for alerts nearby"},historical:{miles:0,type:"",lat:0,lng:0,message:"Searching for past events nearby"}},t.searchAddress="",t.historical=[],t.predictions=[],t.prediction={summary:"There is no current risk at your location",alert:"success",high_winds:!1,high_pop:!1,high_severity:!1,season:"",forecast:{fires:{risk:0,social:null,in_alert:!1},floods:{risk:0,social:null,in_alert:!1},winter:{risk:0,in_alert:!1},other:{risk:0,in_alert:!1}},counts:{alerts:{floods:0,flash:0,fires:0},historical:{floods:0,flash:0,fires:0}}},s.lat&&s.lng&&(t.position={coords:{latitude:parseFloat(s.lat),longitude:parseFloat(s.lng)}}),angular.extend(t,l.mapOptions(t)),t.forecastOptions=l.chartOptions("forecast");var d=null,p=[];t.getNoaaAlertClass=function(e){switch(e){case"Severe":return"label-danger";case"Moderate":return"label-warning";case"Minor":return"label-info";default:return"label-success"}},t.setProcessMessage=function(e){d?p.push(e):d=a(function(){t.searching=e,d=null,p.length&&t.setProcessMessage(p.shift())},500)},t.ShowAbout=function(){return Custombox.open({target:"#about-modal",effect:"blur",width:800})},t.getLocation=function(e){return e.length<3?"":l.address(e).then(function(e){return e.map(function(e){return e.description})})},t.Search=function(e){(e.type&&"submit"==e.type||e&&13===e.which)&&l.geocodeAddress(this.searchAddress).then(function(e){o.go("location",{state:e.state,lat:e.geometry.location.lat,lng:e.geometry.location.lng})})},t.zoomToAddress=function(){c.getMap().then(function(e){e.setView(L.latLng(t.position.coords.latitude,t.position.coords.longitude),12,{animate:!0})})},t.centerJSON=function(e){c.getMap().then(function(s){var r=[];t.position&&r.push(L.GeoJSON.coordsToLatLng([t.position.coords.longitude,t.position.coords.latitude]));for(var o in t.geojson[e].data.features[0].geometry.coordinates){var i=t.geojson[e].data.features[0].geometry.coordinates[o];for(var a in i){var n=i[a];for(var c in n)r.push(L.GeoJSON.coordsToLatLng(n[c]))}}return s.fitBounds(r)})},t.addEsriLayers=function(){},t.getGeo=function(){t.setProcessMessage("Getting geo location...");var e=n.defer();return t.position?e.resolve(!0):l.getLocation().then(function(s){t.position=s,e.resolve(!0)}),e.promise},t.getMarker=function(){var e=n.defer();return l.geocode(t.position.coords).then(function(s){t.markers.push({icon:l.mapIcons("locations"),lat:t.position.coords.latitude,lng:t.position.coords.longitude,message:s.formatted_address}),t.geocode.formatted_address=s.formatted_address,t.geocode.geometry=s.geometry,t.geocode.found_state=s.state,"location"==t.currentName&&(t.geocode.state=s.state),e.resolve(!0)}),e.promise},t.getUrtheCast=function(){t.setProcessMessage("Analyzing UrtheCast satellite data...");var e=n.defer();return l.urthecast(t.position.coords).then(function(s){s.payload&&s.payload.length&&(t.prediction.season=s.payload[0].season),e.resolve(!0)}),e.promise},t.getTweets=function(e){t.setProcessMessage("Analyzing tweets for "+e.replace("%23","#")+"...");var s=n.defer();return l.tweets(e,t.position.coords).then(function(e){e&&e.search&&e.search.results?(t.prediction.forecast.floods.social=e.search.results,s.resolve(e.search.results)):s.resolve(0)}),s.promise},t.getHistorical=function(){t.setProcessMessage("Analyzing historical storm events...");var e=n.defer(),s="";return t.nearest.historical.message="Searching for past events nearby",l.historical(t.position.coords).then(function(o){if(o&&o.rows){t.historical=o.rows;for(r in o.rows)s="<strong>"+o.rows[r].doc.EVENT_TYPE+"</strong>",""!=o.rows[r].doc.BEGIN_DATE_TIME&&(s+="<br/>"+i("moment")(o.rows[r].doc.BEGIN_DATE_TIME)),""!=o.rows[r].doc.EVENT_NARRATIVE?s+="<br/>"+o.rows[r].doc.EVENT_NARRATIVE:""!=o.rows[r].doc.EPISODE_NARRATIVE&&(s+="<br/>"+o.rows[r].doc.EPISODE_NARRATIVE),t.markers.push({icon:l.mapIcons("historical"),lat:o.rows[r].geometry.coordinates[1],lng:o.rows[r].geometry.coordinates[0],message:s}),o.rows[r].distance=l.calcNearestHistorical(t,o.rows[r].doc.EVENT_TYPE,o.rows[r].geometry.coordinates[1],o.rows[r].geometry.coordinates[0]);t.nearest.historical.message="The nearest historical event ("+t.nearest.historical.type+")"}else t.nearest.historical.message="There are no past events nearby";e.resolve(!0)}),e.promise},t.getAlerts=function(){t.setProcessMessage("Analyzing nearby NOAA alerts...");var e=n.defer();return t.nearest.alert.message="Searching for alerts nearby",l.alerts(t.geocode.state.toLowerCase()).then(function(s){t.alerts=s,l.mapParseAlerts(s,t),t.nearest.alert.lat&&t.nearest.alert.lng&&(c.getMap().then(function(e){var s=L.geodesicPolyline([L.latLng(t.position.coords.latitude,t.position.coords.longitude),L.latLng(t.nearest.alert.lat,t.nearest.alert.lng)],{color:"#428bca"});s.addTo(e)}),t.position&&geolib.getElevation([{lat:t.position.coords.latitude,lng:t.position.coords.longitude},{lat:t.nearest.alert.lat,lng:t.nearest.alert.lng}],function(e,s){t.geocode.elev=3.28084*s[0].elev,t.nearest.alert.elev=3.28084*s[1].elev,-1!==t.nearest.alert.type.toLowerCase().indexOf("flood")&&t.nearest.alert.miles<10&&t.geocode.elev<t.nearest.alert.elev&&t.predictions.push({message:"Be aware you are below a flood alert area",type:"danger",icon:"ship"})})),s.length&&"There are no active watches, warnings or advisories"!=s[0].title[0]?t.nearest.alert.message="The nearest alert ("+t.nearest.alert.type+")":(t.nearest.alert.icon="exclamation",t.nearest.alert.message="There are no alerts nearby"),e.resolve(!0)}),e.promise},t.getForecast=function(){t.setProcessMessage("Analyzing weather foreast...");var e=n.defer(),s=[],r=[],o=[],i=[],a=[],c=[],d=0,p=0;return l.forecast(t.position.coords,"24").then(function(n){for(var l in n.forecasts){d+=n.forecasts[l].pop,p+=n.forecasts[l].severity;var f=new Date(n.forecasts[l].fcst_valid_local);s.push([f.getTime(),n.forecasts[l].dewpt]),r.push([f.getTime(),n.forecasts[l].mslp]),o.push([f.getTime(),n.forecasts[l].wspd]),i.push([f.getTime(),n.forecasts[l].gust]),a.push([f.getTime(),n.forecasts[l].pop]),c.push([f.getTime(),n.forecasts[l].temp]),n.forecasts[l].wspd>=40&&(t.prediction.forecast.high_winds=!0)}d/n.forecasts.length>50&&(t.prediction.forecast.high_pop=!0),p/n.forecasts.length>3&&(t.prediction.forecast.high_severity=!0),t.forecastData=[{key:"Dew Point",values:s},{key:"Mean Sea Level Pressure",values:r},{key:"Wind Speed",values:o},{key:"Wind Gust",values:i},{key:"Probability of Precipitation",values:a},{key:"Temperature F",values:c}],t.forecast=n,e.resolve(!0)}),e.promise},t.calcPrediction=function(){t.setProcessMessage("Calculating prediction..."),t.prediction.forecast.fires.in_alert&&(t.predictions.push({message:"Be aware you are in a NOAA fire alert area",type:"danger",icon:"fire-extinguisher fa-lg"}),t.prediction.forecast.fires.risk++),t.prediction.counts.alerts.fires&&t.prediction.historical.alerts.fires&&t.prediction.forecast.fires.high_winds?(t.predictions.push({message:"Fire risk is high",type:"danger",icon:"fire-extinguisher fa-lg"}),t.prediction.forecast.fires.risk++,"summer"==t.prediction&&t.prediction.forecast.fires.risk++):t.prediction.counts.alerts.fires&&t.prediction.historical.alerts.fires?(t.predictions.push({message:"Fire risk is medium",type:"warning",icon:"fire-extinguisher fa-lg"}),t.prediction.forecast.fires.risk++,"summer"==t.prediction&&t.prediction.forecast.fires.risk++):t.prediction.counts.alerts.fires?(t.predictions.push({message:"Fire risk is low",type:"info",icon:"fire-extinguisher fa-lg"}),t.prediction.forecast.fires.risk++,"summer"==t.prediction&&t.prediction.forecast.fires.risk++):t.prediction.forecast.fires.in_alert||t.predictions.push({message:"There is no risk of fires",type:"success"}),t.prediction.forecast.floods.in_alert&&(t.predictions.push({message:"Be aware you are in a NOAA flood alert area",type:"danger",icon:"ship fa-lg"}),t.prediction.forecast.floods.risk++),t.prediction.counts.alerts.flash&&t.prediction.counts.historical.flash&&t.prediction.counts.alerts.floods&&t.prediction.counts.historical.floods&&t.prediction.forecast.floods.high_pop?(t.predictions.push({message:"Flash flood risk is high",type:"danger",icon:"ship fa-lg"}),t.prediction.forecast.floods.risk++):t.prediction.counts.alerts.floods&&t.prediction.counts.historical.floods?(t.predictions.push({message:"Flood risk is medium",type:"warning",icon:"ship fa-lg"}),t.prediction.forecast.floods.risk++):t.prediction.counts.alerts.flash&&t.prediction.counts.historical.flash?(t.predictions.push({message:"Flash flood risk is medium",type:"warning",icon:"ship fa-lg"}),t.prediction.forecast.floods.risk++):t.prediction.counts.alerts.floods?(t.predictions.push({message:"Flood risk is low",type:"info",icon:"ship fa-lg"}),t.prediction.forecast.floods.risk++):t.prediction.forecast.floods.in_alert||t.predictions.push({message:"There is no risk of flooding",type:"success"}),t.prediction.forecast.high_winds&&(t.predictions.push({message:"High winds are forecasted",type:"warning"}),t.prediction.forecast.fires.risk++),t.prediction.forecast.high_pop&&(t.predictions.push({message:"High Precipitation is forecasted",type:"warning"}),t.prediction.forecast.floods.risk++),t.prediction.forecast.high_severity&&t.predictions.push({message:"Weather Severity is high",type:"warning"})},t.getGeo().then(function(){return t.getMarker()}).then(function(){n.all([t.getForecast(),t.getHistorical(),t.getAlerts(),t.getUrtheCast()]).then(function(){return t.calcPrediction()},function(e){t.predictions.push({message:e,type:"danger"})}).then(function(){var e=[];return t.prediction.forecast.floods.risk>0&&e.push(t.getTweets("%23flood").then(function(e){e&&(t.predictions.push({message:"People are talking about #Flood",type:"info",icon:"ship fa-lg"}),t.prediction.forecast.floods.risk++)})),t.prediction.forecast.fires.risk>0&&e.push(t.getTweets("%23fire").then(function(e){e&&(t.predictions.push({message:"People are talking about #Fire",type:"info",icon:"fire-extinguisher fa-lg"}),t.prediction.forecast.fires.risk++)})),n.all(e)}).then(function(){t.setProcessMessage(""),t.addEsriLayers()})})});