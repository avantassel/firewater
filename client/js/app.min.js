var firewaterApp=angular.module("firewater",["lbServices","ui.router","leaflet-directive","duScroll","nvd3","ui.bootstrap","ngGeolocation"]).config(function(e,t,o,r,n,a){n.defaults.useXDomain=!0,n.defaults.headers.common="Content-Type: application/xml",delete n.defaults.headers.common["X-Requested-With"],a.strictMode(!1),e.state("home",{url:"",controller:"mainCtrl",templateUrl:"views/home.html"}).state("state",{url:"/state/:state",controller:"mainCtrl",templateUrl:"views/home.html"}).state("location",{url:"/location/:lat,:lng",controller:"mainCtrl",templateUrl:"views/home.html"}).state("otherwise",{url:"*path",templateUrl:"views/not-found.html"}),r.debugEnabled(!1)});firewaterApp.controller("mainCtrl",function(e,t,o,r,n,a,s){t.geocode={state:o.state||"us",formatted_address:"",geometry:{location:{lat:o.lat||0,lng:o.lng||0}}},t.currentName=r.current.name,t.position=null,t.alerts=null,t.inAlertArea=[],t.forecast=null,t.areaPolygonAlerts=null,t.geoAlerts={},t.markers=[],t.geojson={floods:{},fires:{},winter:{},other:{}},t.nearestAlert={miles:0,type:"circle-o-notch fa-spin",lat:0,lng:0},t.searchAddress="",o.lat&&o.lng&&(t.position={coords:{latitude:parseFloat(o.lat),longitude:parseFloat(o.lng)}}),t.ShowAbout=function(){return Custombox.open({target:"#about-modal",effect:"blur",width:800})},t.getLocation=function(e){return e.length<3?"":s.address(e).then(function(e){return e.map(function(e){return e.description})})},t.Search=function(e){(e.type&&"submit"==e.type||e&&13===e.which)&&s.geocodeAddress(this.searchAddress).then(function(e){r.go("location",{state:e.state,lat:e.geometry.location.lat,lng:e.geometry.location.lng})})},t.forecastOptions={title:{enable:!0,text:"24 Hour Forecast"},chart:{type:"stackedAreaChart",height:450,margin:{top:20,right:20,bottom:30,left:40},x:function(e){return e[0]},y:function(e){return e[1]},useVoronoi:!1,clipEdge:!0,duration:200,useInteractiveGuideline:!0,interactiveLayer:{tooltip:{headerFormatter:function(e){return e}}},xAxis:{showMaxMin:!1,tickFormat:function(e){return d3.time.format("%I:%M%p")(new Date(e))}},yAxis:{tickFormat:function(e){return d3.format(",.2f")(e)}},zoom:{enabled:!0,scaleExtent:[1,10],useFixedDomain:!1,useNiceScale:!1,horizontalOff:!1,verticalOff:!0,unzoomEventType:"dblclick.zoom"}}},angular.extend(t,s.mapOptions(t)),t.position?s.geocode(t.position.coords).then(function(e){return t.markers.push({icon:s.mapIcons(),lat:t.position.coords.latitude,lng:t.position.coords.longitude,message:e.formatted_address}),t.geocode.formatted_address=e.formatted_address,t.geocode.geometry=e.geometry,t.geocode.found_state=e.state,"location"==t.currentName&&(t.geocode.state=e.state),!0}).then(function(){return t.getForecast()}).then(function(){return t.getAlerts()}):s.getLocation().then(function(e){t.position=e,s.geocode(e.coords).then(function(o){return t.markers.push({icon:s.mapIcons(),lat:e.coords.latitude,lng:e.coords.longitude,message:o.formatted_address}),t.geocode.formatted_address=o.formatted_address,t.geocode.geometry=o.geometry,t.geocode.found_state=o.state,!0}).then(function(){return t.getForecast()}).then(function(){return t.getAlerts()})},function(e){t.getAlerts()}),t.getForecast=function(){var e=[],o=[],r=[],n=[],a=[],i=[];s.forecast(t.position.coords,"24").then(function(s){for(var l in s.forecasts){var c=new Date(s.forecasts[l].fcst_valid_local);e.push([c.getTime(),s.forecasts[l].dewpt]),o.push([c.getTime(),s.forecasts[l].mslp]),r.push([c.getTime(),s.forecasts[l].wspd]),n.push([c.getTime(),s.forecasts[l].qpf]),a.push([c.getTime(),s.forecasts[l].snow_qpf]),i.push([c.getTime(),s.forecasts[l].temp])}return t.forecastData=[{key:"Dew Point",values:e},{key:"Mean Sea Level Pressure",values:o},{key:"Wind Speed",values:r},{key:"Quantitative Precipitation Forecast",values:n},{key:"Snow Quantitative Precipitation Forecast",values:a},{key:"Temperature F",values:i}],t.forecast=s})},t.centerJSON=function(e){a.getMap().then(function(o){var r=[];t.position&&r.push(L.GeoJSON.coordsToLatLng([t.position.coords.longitude,t.position.coords.latitude]));for(var n in t.geojson[e].data.features[0].geometry.coordinates){var a=t.geojson[e].data.features[0].geometry.coordinates[n];for(var s in a){var i=a[s];for(var l in i)r.push(L.GeoJSON.coordsToLatLng(i[l]))}}return o.fitBounds(r)})},t.getAlerts=function(){s.alerts(t.geocode.state).then(function(e){t.alerts=e,s.mapAlerts(e,t),t.nearestAlert.lat&&t.nearestAlert.lng&&a.getMap().then(function(e){var o=L.geodesicPolyline([L.latLng(t.position.coords.latitude,t.position.coords.longitude),L.latLng(t.nearestAlert.lat,t.nearestAlert.lng)],{color:"#428bca"});o.addTo(e)}),-1!==t.nearestAlert.type.indexOf("spin")&&(t.nearestAlert.type="exclamation")})}});