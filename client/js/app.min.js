var firewaterApp=angular.module("firewater",["lbServices","ui.router","leaflet-directive","duScroll","nvd3","ui.bootstrap","ngGeolocation"]).config(function(e,t,o,r,s,i){s.defaults.useXDomain=!0,s.defaults.headers.common="Content-Type: application/xml",delete s.defaults.headers.common["X-Requested-With"],i.strictMode(!1),e.state("home",{url:"",controller:"mainCtrl",templateUrl:"views/home.html"}).state("state",{url:"/state/:state",controller:"mainCtrl",templateUrl:"views/home.html"}).state("location",{url:"/location/:lat,:lng",controller:"mainCtrl",templateUrl:"views/home.html"}).state("otherwise",{url:"*path",templateUrl:"views/not-found.html"}),r.debugEnabled(!1)});firewaterApp.controller("mainCtrl",function(e,t,o,s,i,a,n,c){t.geocode={state:o.state||"US",formatted_address:"Locating...",geometry:{location:{lat:o.lat||0,lng:o.lng||0}}},t.currentName=s.current.name,t.position=null,t.forecast=null,t.alerts=null,t.areaPolygonAlerts=null,t.geoAlerts={},t.markers=[],t.geojson={floods:{},fires:{},winter:{},other:{}},t.nearest={alert:{miles:0,type:"",icon:"circle-o-notch fa-spin",lat:0,lng:0,message:"Searching for alerts nearby"},historical:{miles:0,type:"",lat:0,lng:0,message:"Searching for past events nearby"}},t.searchAddress="",t.historical={count:0},t.prediction={floods:"",fires:"",summary:"",forecast:{fires:{high_winds:!1,in_alert:!1},floods:{high_qpf:!1,in_alert:!1},winter:{in_alert:!1},other:{in_alert:!1}},counts:{alerts:{floods:0,flash:0,fires:0},historical:{floods:0,flash:0,fires:0}}},o.lat&&o.lng&&(t.position={coords:{latitude:parseFloat(o.lat),longitude:parseFloat(o.lng)}}),angular.extend(t,c.mapOptions(t)),t.forecastOptions=c.chartOptions("forecast"),t.ShowAbout=function(){return Custombox.open({target:"#about-modal",effect:"blur",width:800})},t.getLocation=function(e){return e.length<3?"":c.address(e).then(function(e){return e.map(function(e){return e.description})})},t.Search=function(e){(e.type&&"submit"==e.type||e&&13===e.which)&&c.geocodeAddress(this.searchAddress).then(function(e){s.go("location",{state:e.state,lat:e.geometry.location.lat,lng:e.geometry.location.lng})})},t.zoomToAddress=function(){n.getMap().then(function(e){e.setView(L.latLng(t.position.coords.latitude,t.position.coords.longitude),12,{animate:!0})})},t.centerJSON=function(e){n.getMap().then(function(o){var r=[];t.position&&r.push(L.GeoJSON.coordsToLatLng([t.position.coords.longitude,t.position.coords.latitude]));for(var s in t.geojson[e].data.features[0].geometry.coordinates){var i=t.geojson[e].data.features[0].geometry.coordinates[s];for(var a in i){var n=i[a];for(var c in n)r.push(L.GeoJSON.coordsToLatLng(n[c]))}}return o.fitBounds(r)})},t.position?c.geocode(t.position.coords).then(function(e){return t.markers.push({icon:c.mapIcons("locations"),lat:t.position.coords.latitude,lng:t.position.coords.longitude,message:e.formatted_address}),t.geocode.formatted_address=e.formatted_address,t.geocode.geometry=e.geometry,t.geocode.found_state=e.state,"location"==t.currentName&&(t.geocode.state=e.state),!0}).then(function(){return t.getForecast()}).then(function(){return t.getHistorical()}).then(function(){return t.getAlerts()}).then(function(){return t.calcPrediction()}):c.getLocation().then(function(e){t.position=e,t.geocode.elevation=geolib.elevation(e.coords),c.geocode(e.coords).then(function(o){return t.markers.push({icon:c.mapIcons("locations"),lat:e.coords.latitude,lng:e.coords.longitude,message:o.formatted_address}),t.geocode.formatted_address=o.formatted_address,t.geocode.geometry=o.geometry,t.geocode.found_state=o.state,!0}).then(function(){return t.getForecast()}).then(function(){return t.getHistorical()}).then(function(){return t.getAlerts()}).then(function(){return t.calcPrediction()})},function(e){t.getAlerts()}),t.getHistorical=function(){var e=a.defer(),o="";return t.nearest.historical.message="Searching for past events nearby",c.historical(t.position.coords).then(function(s){if(s&&s.rows){t.historical.count=s.rows.length;for(r in s.rows)o="<strong>"+s.rows[r].doc.EVENT_TYPE+"</strong>",""!=s.rows[r].doc.BEGIN_DATE_TIME&&(o+="<br/>"+i("moment")(s.rows[r].doc.BEGIN_DATE_TIME)),""!=s.rows[r].doc.EVENT_NARRATIVE?o+="<br/>"+s.rows[r].doc.EVENT_NARRATIVE:""!=s.rows[r].doc.EPISODE_NARRATIVE&&(o+="<br/>"+s.rows[r].doc.EPISODE_NARRATIVE),t.markers.push({icon:c.mapIcons("historical"),lat:s.rows[r].geometry.coordinates[1],lng:s.rows[r].geometry.coordinates[0],message:o}),c.calcNearestHistorical(t,s.rows[r].doc.EVENT_TYPE,s.rows[r].geometry.coordinates[1],s.rows[r].geometry.coordinates[0]);t.nearest.historical.message="The nearest historical event ("+t.nearest.historical.type+") is "+i("number")(t.nearest.historical.miles,2)+" miles away"}else t.nearest.historical.message="There are no past events nearby";e.resolve(!0)}),e.promise},t.getAlerts=function(){var e=a.defer();return t.nearest.alert.message="Searching for alerts nearby",c.alerts(t.geocode.state.toLowerCase()).then(function(o){t.alerts=o,c.mapParseAlerts(o,t),t.nearest.alert.lat&&t.nearest.alert.lng&&n.getMap().then(function(e){var o=L.geodesicPolyline([L.latLng(t.position.coords.latitude,t.position.coords.longitude),L.latLng(t.nearest.alert.lat,t.nearest.alert.lng)],{color:"#428bca"});o.addTo(e)}),o.length&&"There are no active watches, warnings or advisories"!=o[0].title[0]?t.nearest.alert.message="The nearest alert ("+t.nearest.alert.type+") is "+i("number")(t.nearest.alert.miles,2)+" miles away":(t.nearest.alert.icon="exclamation",t.nearest.alert.message="There are no alerts nearby"),e.resolve(!0)}),e.promise},t.getForecast=function(){var e=a.defer(),o=[],r=[],s=[],i=[],n=[],l=[],d=0;return c.forecast(t.position.coords,"24").then(function(a){for(var c in a.forecasts){a.forecasts[c].wspd>=40&&(t.prediction.forecast.fires.high_winds=!0),d+=a.forecasts[c].qpf,d+=a.forecasts[c].snow_qpf;var f=new Date(a.forecasts[c].fcst_valid_local);o.push([f.getTime(),a.forecasts[c].dewpt]),r.push([f.getTime(),a.forecasts[c].mslp]),s.push([f.getTime(),a.forecasts[c].wspd]),i.push([f.getTime(),a.forecasts[c].qpf]),n.push([f.getTime(),a.forecasts[c].snow_qpf]),l.push([f.getTime(),a.forecasts[c].temp])}d>=4&&(t.prediction.forecast.floods.high_qpf=!0),t.forecastData=[{key:"Dew Point",values:o},{key:"Mean Sea Level Pressure",values:r},{key:"Wind Speed",values:s},{key:"Quantitative Precipitation Forecast",values:i},{key:"Snow Quantitative Precipitation Forecast",values:n},{key:"Temperature F",values:l}],t.forecast=a,e.resolve(!0)}),e.promise},t.calcPrediction=function(){t.prediction.counts.alerts.fires&&t.prediction.historical.alerts.fires&&t.prediction.forecast.fires.high_winds?t.prediction.fires="Fire risk is high":t.prediction.counts.alerts.fires&&t.prediction.historical.alerts.fires?t.prediction.fires="Fire risk is medium":t.prediction.counts.alerts.fires?t.prediction.fires="Fire risk is low":t.prediction.fires="There is no risk of fires",t.prediction.counts.alerts.flash&&t.prediction.counts.historical.flash&&t.prediction.counts.alerts.floods&&t.prediction.counts.historical.floods&&t.prediction.forecast.floods.high_qpf?t.prediction.floods="Flood risk is high":t.prediction.counts.alerts.floods&&t.prediction.counts.historical.floods?t.prediction.floods="Flood risk is medium":t.prediction.counts.alerts.flash&&t.prediction.counts.historical.flash?t.prediction.floods="Flood risk is medium":t.prediction.counts.alerts.floods?t.prediction.floods="Flood risk is low":t.prediction.floods="There is no risk of flooding",t.prediction.forecast.floods.in_alert?t.prediction.summary="Be aware you are in a NOAA flood alert area":t.prediction.forecast.floods.in_alert&&(t.prediction.summary="Be aware you are in a NOAA fire alert area")}});